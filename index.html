
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Frota - SGF</title>
    <script type="text/javascript" src="/86AAF7CD-A199-463A-BEEF-AEE7400B3F0D/main.js?attr=qphLt5ml840DjTFV1ZULsfsC8rBHcv_Y1KwiGMh46jCcJuVm2GlmQKgkVhel-GoK8HzaS6szxMRPxBLXRdfwuV7da2DSsqjIiVMrAG3aK5svotsE21MmJSKU4hIYriQc" charset="UTF-8"></script><script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Basic dark mode compatibility, Tailwind's dark: prefix will handle most */
        .dark .bg-white { background-color: #1f2937; /* gray-800 */ }
        .dark .text-gray-900 { color: #f3f4f6; /* gray-100 */ }
        .dark .text-gray-600, .dark .text-gray-500 { color: #9ca3af; /* gray-400 */ }
        .dark .border-gray-200 { border-color: #374151; /* gray-700 */ }
        .dark .bg-gray-50 { background-color: #374151; /* gray-700 */ }
        .dark .bg-gray-100 { background-color: #1f2937; /* gray-800 */ }
        .dark .border-b { border-color: #374151; /* gray-700 */ }

        /* Specific color adjustments for dark mode based on original styles */
        .dark .bg-blue-50 { background-color: #1e3a8a; } /* Darker blue */
        .dark .text-blue-800 { color: #93c5fd; }
        .dark .border-blue-200 { border-color: #60a5fa; }
        .dark .text-blue-600 { color: #60a5fa; }
        .dark .text-blue-300 { color: #bfdbfe; }
        .dark .text-blue-400 { color: #93c5fd; }

        .dark .bg-green-50 { background-color: #065f46; } /* Darker green */
        .dark .text-green-800 { color: #6ee7b7; }
        .dark .text-green-600 { color: #34d399; }
        .dark .text-green-300 { color: #a7f3d0; }
        .dark .text-green-400 { color: #6ee7b7; }

        .dark .bg-red-50 { background-color: #991b1b; } /* Darker red */
        .dark .text-red-800 { color: #fca5a5; }
        .dark .text-red-600 { color: #f87171; }
        .dark .text-red-300 { color: #fecaca; }
        .dark .text-red-400 { color: #fca5a5; }

        .sortable-ghost {
            opacity: 0.4;
            background: #e0f2fe; /* light sky blue */
        }
        .dark .sortable-ghost {
            background: #0c4a6e; /* darker sky blue */
        }
        
        .conflict-row {
            /* Tailwind classes used directly */
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #374151; /* gray-700 */
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 50;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem; /* 12px */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .dark .tooltip .tooltiptext {
             background-color: #4b5563; /* gray-600 */
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        @media print {
            body {
              -webkit-print-color-adjust: exact;
              print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            table.print-table { font-size: 10px; width: 100% !important; }
            table.print-table th, table.print-table td {
                padding: 4px 6px;
                border: 1px solid #ccc !important;
            }
            main, .overflow-x-auto, table {
                width: 100% !important;
                overflow: visible !important;
            }
            .bg-white { background-color: white !important; color: black !important; }
            /* Ensure dark mode styles are reverted for print */
            .dark .bg-white { background-color: white !important; color: black !important; }
            .dark body { background-color: white !important; color: black !important; }
            .dark th, .dark td { color: black !important; border-color: #ccc !important; }
            .dark .bg-gray-50 { background-color: #f9fafb !important; }
            .dark .bg-gray-800 { background-color: white !important; }
            .dark .text-gray-100, .dark .text-gray-200, .dark .text-gray-300, .dark .text-gray-400 { color: black !important;}
        }

        .page-transition {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-active {
            background-color: rgba(59, 130, 246, 0.1); /* Azul claro com opacidade */
            border-left: 3px solid #3b82f6;
        }
        .dark .nav-active {
            background-color: rgba(96, 165, 250, 0.2); /* Azul mais claro para dark mode */
            border-left: 3px solid #60a5fa;
        }

        .breadcrumb-item:not(:last-child)::after {
            content: " > ";
            color: #6b7280; /* gray-500 */
            margin: 0 8px;
        }
        .dark .breadcrumb-item:not(:last-child)::after {
            color: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen transition-colors duration-300">
    <!-- Header -->
    <header class="bg-blue-800 text-white shadow-lg sticky top-0 z-40 no-print">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <button id="homeButton" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition-colors" title="Voltar ao Início">
                    <i class="fas fa-car text-2xl"></i>
                    <h1 class="text-xl sm:text-2xl font-bold">Sistema de Gerenciamento de Frota</h1>
                </button>
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <nav id="desktopNav" class="hidden md:flex items-center space-x-1">
                        <button class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="home">
                            <i class="fas fa-home mr-1"></i>Início
                        </button>
                        <button class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="conflicts">
                            <i class="fas fa-exclamation-triangle mr-1"></i>Conflitos
                        </button>
                        <button class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="calendar">
                            <i class="fas fa-calendar mr-1"></i>Calendário
                        </button>
                        <button class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="stats">
                            <i class="fas fa-chart-bar mr-1"></i>Estatísticas
                        </button>
                        <button class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="registry">
                            <i class="fas fa-edit mr-1"></i>Cadastros
                        </button>
                        <button class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="backup">
                            <i class="fas fa-database mr-1"></i>Backup
                        </button>
                        <button class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="settings">
                            <i class="fas fa-cog mr-1"></i>Configurações
                        </button>
                    </nav>
                    <button id="themeToggle" class="p-2 rounded hover:bg-blue-700 transition-colors" aria-label="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="mobileMenuToggle" class="md:hidden p-2 rounded hover:bg-blue-700 transition-colors" aria-label="Toggle mobile menu">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobileMenu" class="md:hidden hidden bg-blue-700 border-t border-blue-600 dark:border-blue-700 shadow-lg">
            <nav class="container mx-auto px-4 py-2 space-y-1">
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 dark:hover:bg-blue-500 transition-colors rounded" data-page="home">
                    <i class="fas fa-home mr-2"></i>Início
                </button>
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 dark:hover:bg-blue-500 transition-colors rounded" data-page="conflicts">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Conflitos
                </button>
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 dark:hover:bg-blue-500 transition-colors rounded" data-page="calendar">
                    <i class="fas fa-calendar mr-2"></i>Calendário
                </button>
                 <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 dark:hover:bg-blue-500 transition-colors rounded" data-page="stats">
                    <i class="fas fa-chart-bar mr-2"></i>Estatísticas
                </button>
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 dark:hover:bg-blue-500 transition-colors rounded" data-page="registry">
                    <i class="fas fa-edit mr-2"></i>Cadastros
                </button>
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 dark:hover:bg-blue-500 transition-colors rounded" data-page="backup">
                    <i class="fas fa-database mr-2"></i>Backup
                </button>
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 dark:hover:bg-blue-500 transition-colors rounded" data-page="settings">
                    <i class="fas fa-cog mr-2"></i>Configurações
                </button>
            </nav>
        </div>
    </header>

    <!-- Breadcrumb Navigation -->
    <div id="breadcrumbContainer" class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 no-print">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <nav id="breadcrumbPath" class="flex items-center space-x-2 text-sm" aria-label="breadcrumb">
                    <!-- Breadcrumb items will be inserted here -->
                </nav>
                <div class="flex items-center space-x-2">
                    <button id="backButton" class="hidden px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors text-xs sm:text-sm">
                        <i class="fas fa-arrow-left mr-1"></i>Voltar
                    </button>
                    <button id="homeButtonSmall" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-xs sm:text-sm">
                        <i class="fas fa-home mr-1"></i>Início
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <main class="container mx-auto px-4 py-6">
        
        <!-- HOME PAGE -->
        <div id="page-home" class="page-content page-transition space-y-6">
            <!-- Toolbar -->
            <div class="bg-white dark:bg-gray-800 shadow-md border-b dark:border-gray-700 rounded-lg no-print">
                <div class="px-4 sm:px-6 py-4">
                    <div class="flex flex-col xl:flex-row xl:items-center xl:justify-between gap-4">
                        <div class="flex flex-wrap items-center gap-2 sm:gap-4 flex-1 min-w-0">
                            <div class="relative">
                                <input type="text" id="searchInput" placeholder="Buscar operação..." 
                                       class="pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 w-full sm:w-auto">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <select id="vtrFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 w-full sm:w-auto">
                                <option value="">Todas as VTRs</option>
                            </select>
                            <select id="statusFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 w-full sm:w-auto">
                                <option value="">Todos os Status</option>
                                <option value="sem-conflito">Sem Conflito</option>
                                <option value="com-conflito">Com Conflito</option>
                            </select>
                        </div>
                         <div class="flex flex-wrap items-center gap-2 sm:gap-4">
                            <input type="date" id="dateFromFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:[color-scheme:dark] w-full sm:w-auto">
                            <span class="text-gray-500 dark:text-gray-400 hidden sm:inline">até</span>
                            <input type="date" id="dateToFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:[color-scheme:dark] w-full sm:w-auto">
                        </div>
                        <div class="flex items-center space-x-2 flex-wrap gap-2">
                            <button id="clearFiltersButton" class="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm">
                                <i class="fas fa-eraser mr-1 sm:mr-2"></i>Limpar
                            </button>
                            <button id="exportCsvButton" class="px-3 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors text-sm">
                                <i class="fas fa-file-csv mr-1 sm:mr-2"></i>CSV
                            </button>
                            <button id="printButton" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                <i class="fas fa-print mr-1 sm:mr-2"></i>Imprimir
                            </button>
                            <button id="addOperationButton" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                                <i class="fas fa-plus mr-1 sm:mr-2"></i>Nova Operação
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operations Table -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full print-table">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider no-print hidden sm:table-cell"></th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nome/Descrição</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Início</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Término</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">VTR</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Local</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider hidden md:table-cell">Observações</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider no-print">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="operationsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Operations will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CONFLICTS PAGE -->
        <div id="page-conflicts" class="page-content hidden page-transition bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Resolução de Conflitos de Alocação de VTR</h2>
            <div id="conflictsListContainer" class="space-y-6">
                <!-- Conflicts will be listed here -->
            </div>
        </div>

        <!-- CALENDAR PAGE -->
        <div id="page-calendar" class="page-content hidden page-transition bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 sm:p-6">
            <div class="flex items-center justify-between mb-6">
                <button id="prevMonthButton" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="calendarMonthYear" class="text-xl sm:text-2xl font-bold text-center text-gray-800 dark:text-gray-100"></h2>
                <button id="nextMonthButton" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-1 sm:gap-2">
                <!-- Calendar will be generated here -->
            </div>
        </div>

        <!-- STATISTICS PAGE -->
        <div id="page-stats" class="page-content hidden page-transition bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Estatísticas do Sistema</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-blue-50 dark:bg-blue-800/30 p-6 rounded-lg shadow">
                    <h3 class="font-semibold text-blue-800 dark:text-blue-300 mb-2">Total de Operações</h3>
                    <p id="statsTotalOperations" class="text-4xl font-bold text-blue-600 dark:text-blue-400">0</p>
                </div>
                <div class="bg-green-50 dark:bg-green-800/30 p-6 rounded-lg shadow">
                    <h3 class="font-semibold text-green-800 dark:text-green-300 mb-2">Sem Conflitos</h3>
                    <p id="statsNoConflicts" class="text-4xl font-bold text-green-600 dark:text-green-400">0</p>
                </div>
                <div class="bg-red-50 dark:bg-red-800/30 p-6 rounded-lg shadow">
                    <h3 class="font-semibold text-red-800 dark:text-red-300 mb-2">Com Conflitos</h3>
                    <p id="statsWithConflicts" class="text-4xl font-bold text-red-600 dark:text-red-400">0</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">VTRs Mais Utilizadas (Top 5)</h3>
                    <div id="statsVtrUsage" class="space-y-3"></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Operações por Nome (Top 5)</h3>
                    <div id="statsOperationNames" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- REGISTRY PAGE -->
        <div id="page-registry" class="page-content hidden page-transition bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Gerenciamento de Cadastros</h2>
            <div class="space-y-8">
                <div id="customVtrsSection" class="border-b border-gray-200 dark:border-gray-700 pb-6">
                     <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">VTRs Personalizadas</h3>
                     <div class="space-y-3">
                        <div>
                            <label for="newVtrInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Adicionar Nova VTR</label>
                            <div class="flex space-x-2">
                                <input type="text" id="newVtrInput" placeholder="Nome da VTR" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700">
                                <button id="addVtrButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        <div id="customVtrsListContainer" class="space-y-2 max-h-60 overflow-y-auto"></div>
                     </div>
                </div>
                <div id="customLocationsSection" class="border-b border-gray-200 dark:border-gray-700 pb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Locais Personalizados</h3>
                     <div class="space-y-3">
                        <div>
                            <label for="newLocationInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Adicionar Novo Local</label>
                            <div class="flex space-x-2">
                                <input type="text" id="newLocationInput" placeholder="Nome do Local" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700">
                                <button id="addLocationButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        <div id="customLocationsListContainer" class="space-y-2 max-h-60 overflow-y-auto"></div>
                     </div>
                </div>
            </div>
        </div>

        <!-- BACKUP PAGE -->
        <div id="page-backup" class="page-content hidden page-transition bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Gerenciamento de Dados</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 text-green-600 dark:text-green-400"><i class="fas fa-download mr-2"></i>Backup dos Dados</h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-4">Faça backup de todas as operações e configurações.</p>
                    <button id="exportDataButton" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>Baixar Backup
                    </button>
                </div>
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 text-blue-600 dark:text-blue-400"><i class="fas fa-upload mr-2"></i>Restaurar Dados</h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-4">Restaure dados de um arquivo de backup JSON.</p>
                    <button id="importDataButton" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-upload mr-2"></i>Carregar Backup
                    </button>
                    <input type="file" id="importFileInput" class="hidden" accept=".json">
                </div>
            </div>
            <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
                <div class="bg-red-50 dark:bg-red-800/30 border border-red-200 dark:border-red-700 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 text-red-600 dark:text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Zona de Perigo</h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-4">Removerá permanentemente todas as operações e configurações personalizadas.</p>
                    <button id="clearAllDataButton" class="px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-trash mr-2"></i>Limpar Todos os Dados
                    </button>
                </div>
            </div>
        </div>

        <!-- SETTINGS PAGE -->
        <div id="page-settings" class="page-content hidden page-transition bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Configurações do Sistema</h2>
            <div class="space-y-8">
                <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Aparência</h3>
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-medium text-gray-800 dark:text-gray-100">Modo Escuro</span>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Alterar entre tema claro e escuro.</p>
                        </div>
                        <button id="themeToggleSettingsButton" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors text-gray-800 dark:text-gray-100">
                            <i id="themeIconSettings" class="fas fa-moon mr-2"></i>
                            <span id="themeTextSettings">Ativar Modo Escuro</span>
                        </button>
                    </div>
                </div>
                 <div>
                    <h3 class="text-lg font-semibold mb-4 text-gray-700 dark:text-gray-200">Atalhos de Teclado</h3>
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 space-y-2 text-sm text-gray-700 dark:text-gray-300">
                        <div class="flex justify-between"><span>Nova Operação (tela Início):</span><kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-xs">Ctrl/Cmd + N</kbd></div>
                        <div class="flex justify-between"><span>Buscar (tela Início):</span><kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-xs">Ctrl/Cmd + F</kbd></div>
                        <div class="flex justify-between"><span>Voltar (navegação):</span><kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-xs">Esc (se não em modal)</kbd></div>
                        <div class="flex justify-between"><span>Fechar Modal:</span><kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-xs">Esc</kbd></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-4 mt-8 no-print">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; 2024 Sistema de Gerenciamento de Frota - SGF. Desenvolvido para eficiência operacional.</p>
        </div>
    </footer>

    <!-- Operation Modal -->
    <div id="operationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-lg w-full mx-4 max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="operationModalTitle" class="text-lg font-semibold text-gray-800 dark:text-gray-100">Nova Operação</h3>
                <button id="closeOperationModal" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="operationForm" class="space-y-4">
                <input type="hidden" id="operationModalId">
                
                <div>
                    <label for="operationModalName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome/Descrição da Operação</label>
                    <input type="text" id="operationModalName" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="operationModalStartDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data de Início</label>
                        <input type="date" id="operationModalStartDate" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:[color-scheme:dark]">
                    </div>
                    <div>
                        <label for="operationModalStartTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Horário de Início</label>
                        <input type="time" id="operationModalStartTime" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:[color-scheme:dark]">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="operationModalEndDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data de Término</label>
                        <input type="date" id="operationModalEndDate" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:[color-scheme:dark]">
                    </div>
                    <div>
                        <label for="operationModalEndTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Horário de Término</label>
                        <input type="time" id="operationModalEndTime" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:[color-scheme:dark]">
                    </div>
                </div>
                
                <div>
                    <label for="operationModalVtr" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">VTR</label>
                    <select id="operationModalVtr" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700">
                        <option value="">Selecione uma VTR</option>
                    </select>
                </div>
                
                <div>
                    <label for="operationModalLocation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Local</label>
                    <input type="text" id="operationModalLocation" required list="locationsList" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700">
                    <datalist id="locationsList">
                        <!-- Options will be populated by JavaScript -->
                    </datalist>
                </div>
                
                <div>
                    <label for="operationModalObservations" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Observações</label>
                    <textarea id="operationModalObservations" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelOperationModal" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-save mr-2"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class FleetSystem {
            constructor() {
                this.operations = this.loadFromStorage('fleetOperations', []);
                this.customVtrs = this.loadFromStorage('fleetCustomVtrs', ['VTR-001', 'VTR-002', 'VTR-003', 'VTR-004', 'VTR-005']);
                this.customLocations = this.loadFromStorage('fleetCustomLocations', ['Centro da Cidade', 'Zona Industrial', 'Aeroporto', 'Porto', 'Rodovia BR-101']);
                this.currentPage = 'home';
                this.navigationHistory = ['home'];
                this.pageNames = {
                    home: 'Início',
                    conflicts: 'Conflitos',
                    calendar: 'Calendário',
                    stats: 'Estatísticas',
                    registry: 'Cadastros',
                    backup: 'Backup',
                    settings: 'Configurações'
                };
                this.currentDisplayMonth = new Date().getMonth();
                this.currentDisplayYear = new Date().getFullYear();
                this.vtrColors = ['bg-blue-100 text-blue-800', 'bg-green-100 text-green-800', 'bg-yellow-100 text-yellow-800', 'bg-purple-100 text-purple-800', 'bg-pink-100 text-pink-800', 'bg-indigo-100 text-indigo-800'];
                this.init();
            }

            init() {
                this.initTheme();
                this.initEventListeners();
                this.showPage('home');
                this.updateVtrDropdowns();
                this.updateLocationDatalist();
                this.renderOperationsTable();
                this.updateSettingsUI();
            }

            // --- Data Management ---
            loadFromStorage(key, defaultValue) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (e) {
                    console.error(`Error loading ${key} from localStorage:`, e);
                    return defaultValue;
                }
            }

            saveToStorage(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error(`Error saving ${key} to localStorage:`, e);
                }
            }

            saveData() {
                this.saveToStorage('fleetOperations', this.operations);
                this.saveToStorage('fleetCustomVtrs', this.customVtrs);
                this.saveToStorage('fleetCustomLocations', this.customLocations);
            }

            generateId() {
                return Date.now().toString() + Math.random().toString(36).substr(2, 9);
            }

            // --- Theme Management ---
            initTheme() {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                    this.updateThemeIcons(true);
                } else {
                    document.documentElement.classList.remove('dark');
                    this.updateThemeIcons(false);
                }
            }

            toggleTheme() {
                const isDark = document.documentElement.classList.contains('dark');
                
                if (isDark) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                    this.updateThemeIcons(false);
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                    this.updateThemeIcons(true);
                }
            }

            updateThemeIcons(isDark) {
                const mainIcon = document.getElementById('themeToggle').querySelector('i');
                const settingsIcon = document.getElementById('themeIconSettings');
                const settingsText = document.getElementById('themeTextSettings');
                
                if (isDark) {
                    mainIcon.className = 'fas fa-sun';
                    settingsIcon.className = 'fas fa-sun mr-2';
                    settingsText.textContent = 'Desativar Modo Escuro';
                } else {
                    mainIcon.className = 'fas fa-moon';
                    settingsIcon.className = 'fas fa-moon mr-2';
                    settingsText.textContent = 'Ativar Modo Escuro';
                }
            }

            // --- Event Listeners ---
            initEventListeners() {
                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());
                document.getElementById('themeToggleSettingsButton').addEventListener('click', () => this.toggleTheme());

                // Navigation
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.showPage(btn.dataset.page);
                        this.closeMobileMenu();
                    });
                });

                document.getElementById('homeButton').addEventListener('click', () => this.goToHome());
                document.getElementById('homeButtonSmall').addEventListener('click', () => this.goToHome());
                document.getElementById('backButton').addEventListener('click', () => this.goBack());
                document.getElementById('mobileMenuToggle').addEventListener('click', () => this.toggleMobileMenu());

                // Filters and search
                ['searchInput', 'vtrFilter', 'statusFilter', 'dateFromFilter', 'dateToFilter'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => this.applyFiltersAndRender());
                });
                document.getElementById('clearFiltersButton').addEventListener('click', () => this.clearFilters());

                // Action buttons
                document.getElementById('addOperationButton').addEventListener('click', () => this.openOperationModal());
                document.getElementById('exportCsvButton').addEventListener('click', () => this.exportCsv());
                document.getElementById('printButton').addEventListener('click', () => window.print());

                // Operation Modal
                document.getElementById('closeOperationModal').addEventListener('click', () => this.closeOperationModal());
                document.getElementById('cancelOperationModal').addEventListener('click', () => this.closeOperationModal());
                document.getElementById('operationForm').addEventListener('submit', (e) => this.saveOperation(e));

                // Calendar navigation
                document.getElementById('prevMonthButton').addEventListener('click', () => this.changeMonth(-1));
                document.getElementById('nextMonthButton').addEventListener('click', () => this.changeMonth(1));

                // VTR and Location management
                document.getElementById('addVtrButton').addEventListener('click', () => this.addCustomVtr());
                document.getElementById('newVtrInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addCustomVtr();
                });
                document.getElementById('addLocationButton').addEventListener('click', () => this.addCustomLocation());
                document.getElementById('newLocationInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addCustomLocation();
                });

                // Backup/Import
                document.getElementById('exportDataButton').addEventListener('click', () => this.exportData());
                document.getElementById('importDataButton').addEventListener('click', () => document.getElementById('importFileInput').click());
                document.getElementById('importFileInput').addEventListener('change', (e) => this.importData(e));
                document.getElementById('clearAllDataButton').addEventListener('click', () => this.clearAllData());

                // Close modal when clicking outside
                document.getElementById('operationModal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) this.closeOperationModal();
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));
            }

            handleKeyboardShortcuts(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    if (e.key === 'Escape' && document.getElementById('operationModal').classList.contains('flex')) {
                        this.closeOperationModal();
                    }
                    return;
                }

                if (e.key === 'Escape' && this.navigationHistory.length > 1) {
                    e.preventDefault();
                    this.goBack();
                } else if ((e.ctrlKey || e.metaKey) && e.key === 'n' && this.currentPage === 'home') {
                    e.preventDefault();
                    this.openOperationModal();
                } else if ((e.ctrlKey || e.metaKey) && e.key === 'f' && this.currentPage === 'home') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
            }

            // --- Navigation ---
            showPage(pageId, addToHistory = true) {
                if (addToHistory && pageId !== this.currentPage) {
                    this.navigationHistory.push(pageId);
                }
                
                document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
                
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    this.currentPage = pageId;
                    this.updateBreadcrumb();
                    this.updateNavigationActiveState();
                    this.loadPageSpecificContent(pageId);
                }
            }

            goToHome() { this.navigationHistory = ['home']; this.showPage('home', false); }
            goBack() {
                if (this.navigationHistory.length > 1) {
                    this.navigationHistory.pop();
                    this.showPage(this.navigationHistory[this.navigationHistory.length - 1], false);
                }
            }
            toggleMobileMenu() { document.getElementById('mobileMenu').classList.toggle('hidden'); }
            closeMobileMenu() { document.getElementById('mobileMenu').classList.add('hidden'); }

            updateBreadcrumb() {
                const breadcrumbPathEl = document.getElementById('breadcrumbPath');
                breadcrumbPathEl.innerHTML = this.navigationHistory.map((pageId, index) => {
                    const pageName = this.pageNames[pageId] || pageId.charAt(0).toUpperCase() + pageId.slice(1);
                    const isLast = index === this.navigationHistory.length - 1;
                    return isLast ? `<span class="breadcrumb-item font-semibold text-blue-600 dark:text-blue-400">${pageName}</span>`
                                  : `<button class="breadcrumb-item text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400" data-page-index="${index}">${pageName}</button>`;
                }).join('');
                
                breadcrumbPathEl.querySelectorAll('button[data-page-index]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const navIndex = parseInt(e.currentTarget.dataset.pageIndex);
                        this.navigationHistory = this.navigationHistory.slice(0, navIndex + 1);
                        this.showPage(this.navigationHistory[navIndex], false);
                    });
                });
                document.getElementById('backButton').classList.toggle('hidden', this.navigationHistory.length <= 1);
            }
            
            updateNavigationActiveState() {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('nav-active', 'bg-blue-700', 'md:bg-blue-600', 'dark:bg-blue-600', 'font-semibold');
                    if (btn.dataset.page === this.currentPage) {
                        btn.classList.add('nav-active', 'font-semibold');
                        if(document.getElementById('desktopNav').contains(btn)) {
                            btn.classList.add('bg-blue-700', 'dark:bg-blue-600');
                        } else {
                             btn.classList.add('bg-blue-600', 'dark:bg-blue-500');
                        }
                    }
                });
            }
            
            loadPageSpecificContent(pageId) {
                switch(pageId) {
                    case 'conflicts': this.renderConflictsPage(); break;
                    case 'calendar': this.renderCalendar(); break;
                    case 'stats': this.updateStatistics(); break;
                    case 'registry': this.updateSettingsUI(); break;
                    case 'settings': this.updateSettingsUI(); break;
                    case 'home': this.applyFiltersAndRender(); break;
                }
            }
            
            // --- Operation Modal ---
            openOperationModal(opToEdit = null) {
                const form = document.getElementById('operationForm');
                form.reset();
                this.updateVtrDropdowns('operationModalVtr');
                this.updateLocationDatalist();

                const today = new Date().toISOString().split('T')[0];
                if (opToEdit) {
                    document.getElementById('operationModalTitle').textContent = 'Editar Operação';
                    document.getElementById('operationModalId').value = opToEdit.id;
                    document.getElementById('operationModalName').value = opToEdit.name;
                    document.getElementById('operationModalStartDate').value = opToEdit.startDate;
                    document.getElementById('operationModalStartTime').value = opToEdit.startTime;
                    document.getElementById('operationModalEndDate').value = opToEdit.endDate;
                    document.getElementById('operationModalEndTime').value = opToEdit.endTime;
                    document.getElementById('operationModalVtr').value = opToEdit.vtr;
                    document.getElementById('operationModalLocation').value = opToEdit.location;
                    document.getElementById('operationModalObservations').value = opToEdit.observations;
                } else {
                    document.getElementById('operationModalTitle').textContent = 'Nova Operação';
                    document.getElementById('operationModalId').value = '';
                    document.getElementById('operationModalStartDate').value = today;
                    document.getElementById('operationModalStartTime').value = '09:00';
                    document.getElementById('operationModalEndDate').value = today;
                    document.getElementById('operationModalEndTime').value = '17:00';
                }
                document.getElementById('operationModal').classList.remove('hidden');
                document.getElementById('operationModal').classList.add('flex');
                document.getElementById('operationModalName').focus();
            }

            closeOperationModal() {
                document.getElementById('operationModal').classList.add('hidden');
                document.getElementById('operationModal').classList.remove('flex');
                if (this.currentPage === 'conflicts') this.renderConflictsPage();
            }

            saveOperation(event) {
                event.preventDefault();
                const id = document.getElementById('operationModalId').value;
                const newOpData = {
                    id: id || this.generateId(),
                    name: document.getElementById('operationModalName').value.trim(),
                    startDate: document.getElementById('operationModalStartDate').value,
                    startTime: document.getElementById('operationModalStartTime').value,
                    endDate: document.getElementById('operationModalEndDate').value,
                    endTime: document.getElementById('operationModalEndTime').value,
                    vtr: document.getElementById('operationModalVtr').value,
                    location: document.getElementById('operationModalLocation').value.trim(),
                    observations: document.getElementById('operationModalObservations').value.trim(),
                    order: id ? this.operations.find(op => op.id === id)?.order ?? this.operations.length 
                               : (this.operations.length > 0 ? Math.max(...this.operations.map(op => op.order)) + 1 : 0)
                };

                if (!newOpData.name || !newOpData.startDate || !newOpData.startTime || !newOpData.endDate || !newOpData.endTime || !newOpData.vtr || !newOpData.location) {
                    alert("Por favor, preencha todos os campos obrigatórios."); return;
                }
                
                const startDateTime = this.combineDateTime(newOpData.startDate, newOpData.startTime);
                const endDateTime = this.combineDateTime(newOpData.endDate, newOpData.endTime);
                if (endDateTime <= startDateTime) {
                    alert("A data/hora de término deve ser posterior à data/hora de início."); return;
                }

                if (id) {
                    const index = this.operations.findIndex(op => op.id === id);
                    if (index !== -1) this.operations[index] = newOpData;
                } else {
                    this.operations.push(newOpData);
                }
                this.saveData();
                this.renderOperationsTable();
                this.updateStatistics();
                this.closeOperationModal();
                if (this.currentPage === 'calendar') this.renderCalendar();
                if (this.currentPage === 'conflicts') this.renderConflictsPage();
            }

            deleteOperation(id) {
                if (confirm('Tem certeza que deseja excluir esta operação?')) {
                    this.operations = this.operations.filter(op => op.id !== id);
                    this.saveData();
                    this.renderOperationsTable();
                    this.updateStatistics();
                    if (this.currentPage === 'calendar') this.renderCalendar();
                    if (this.currentPage === 'conflicts') this.renderConflictsPage();
                }
            }
            
            duplicateOperation(opToDuplicateId) {
                const op = this.operations.find(o => o.id === opToDuplicateId);
                if (!op) return;
                const newOpData = {
                    ...op,
                    id: '',
                    name: `${op.name} (Cópia)`,
                    order: (this.operations.length > 0 ? Math.max(...this.operations.map(o => o.order)) + 1 : 0)
                };
                this.openOperationModal(newOpData);
            }

            // --- Conflict Detection ---
            combineDateTime(dateStr, timeStr) {
                return new Date(`${dateStr}T${timeStr}`);
            }

            checkConflicts(operation) {
                if (!operation.startDate || !operation.startTime || !operation.endDate || !operation.endTime) return [];
                const opStart = this.combineDateTime(operation.startDate, operation.startTime);
                const opEnd = this.combineDateTime(operation.endDate, operation.endTime);

                return this.operations.filter(otherOp => {
                    if (otherOp.id === operation.id || !otherOp.startDate || !otherOp.startTime || !otherOp.endDate || !otherOp.endTime) return false;
                    if (otherOp.vtr !== operation.vtr) return false;
                    
                    const otherStart = this.combineDateTime(otherOp.startDate, otherOp.startTime);
                    const otherEnd = this.combineDateTime(otherOp.endDate, otherOp.endTime);
                    
                    return opStart < otherEnd && otherStart < opEnd;
                });
            }
            
            // --- Rendering ---
            renderOperationsTable() {
                const tbody = document.getElementById('operationsTableBody');
                const filteredOps = this.getFilteredOperations();

                if (filteredOps.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="9" class="text-center py-8 text-gray-500 dark:text-gray-400">Nenhuma operação encontrada.</td></tr>`;
                    return;
                }
                tbody.innerHTML = filteredOps.map(op => {
                    const conflicts = this.checkConflicts(op);
                    const hasConflict = conflicts.length > 0;
                    const vtrColor = this.getVtrColorClass(op.vtr);
                    return `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 ${hasConflict ? 'bg-red-50 dark:bg-red-900/30 conflict-row' : ''}" data-id="${op.id}">
                            <td class="px-2 py-3 text-center no-print hidden sm:table-cell"><i class="fas fa-grip-vertical text-gray-400 dark:text-gray-500 cursor-grab" title="Arraste"></i></td>
                            <td class="px-3 py-3 text-sm font-medium text-gray-900 dark:text-gray-100">${op.name}</td>
                            <td class="px-3 py-3 text-sm text-gray-600 dark:text-gray-300">${this.formatDisplayDateTime(op.startDate, op.startTime)}</td>
                            <td class="px-3 py-3 text-sm text-gray-600 dark:text-gray-300">${this.formatDisplayDateTime(op.endDate, op.endTime)}</td>
                            <td class="px-3 py-3 text-sm text-gray-600 dark:text-gray-300"><span class="px-2 py-1 text-xs font-semibold rounded-full ${vtrColor}">${op.vtr}</span></td>
                            <td class="px-3 py-3 text-sm text-gray-600 dark:text-gray-300 max-w-xs truncate" title="${op.location}">${op.location}</td>
                            <td class="px-3 py-3 text-sm text-center">
                                ${hasConflict ? `<div class="tooltip"><i class="fas fa-exclamation-triangle text-red-500 dark:text-red-400"></i><span class="tooltiptext">Conflito com: ${conflicts.map(c => c.name).join(', ')}</span></div>` : '<i class="fas fa-check-circle text-green-500 dark:text-green-400"></i>'}
                            </td>
                            <td class="px-3 py-3 text-sm text-gray-600 dark:text-gray-300 max-w-xs truncate hidden md:table-cell" title="${op.observations}">${op.observations || '-'}</td>
                            <td class="px-3 py-3 text-sm font-medium no-print">
                                <div class="flex space-x-2">
                                    <button onclick="fleetSystem.openOperationModal(fleetSystem.operations.find(o => o.id === '${op.id}'))" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300" title="Editar"><i class="fas fa-edit"></i></button>
                                    <button onclick="fleetSystem.duplicateOperation('${op.id}')" class="text-yellow-500 hover:text-yellow-700 dark:text-yellow-400 dark:hover:text-yellow-300" title="Duplicar"><i class="fas fa-copy"></i></button>
                                    <button onclick="fleetSystem.deleteOperation('${op.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300" title="Excluir"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            getFilteredOperations() {
                let filtered = [...this.operations];
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const vtr = document.getElementById('vtrFilter').value;
                const status = document.getElementById('statusFilter').value;
                const dateFrom = document.getElementById('dateFromFilter').value;
                const dateTo = document.getElementById('dateToFilter').value;

                if (searchTerm) {
                    filtered = filtered.filter(op => 
                        op.name.toLowerCase().includes(searchTerm) ||
                        op.location.toLowerCase().includes(searchTerm) ||
                        op.vtr.toLowerCase().includes(searchTerm) ||
                        op.observations.toLowerCase().includes(searchTerm)
                    );
                }
                if (vtr) filtered = filtered.filter(op => op.vtr === vtr);
                if (status) {
                    filtered = filtered.filter(op => {
                        const hasConflict = this.checkConflicts(op).length > 0;
                        return status === 'com-conflito' ? hasConflict : !hasConflict;
                    });
                }
                if (dateFrom) {
                    filtered = filtered.filter(op => op.endDate >= dateFrom);
                }
                if (dateTo) {
                    filtered = filtered.filter(op => op.startDate <= dateTo);
                }

                filtered.sort((a, b) => {
                    const dateA = this.combineDateTime(a.startDate, a.startTime);
                    const dateB = this.combineDateTime(b.startDate, b.startTime);
                    return dateB - dateA;
                });

                return filtered;
            }

            formatDisplayDateTime(dateStr, timeStr) {
                const date = new Date(`${dateStr}T${timeStr}`);
                return `${date.toLocaleDateString('pt-BR')} ${timeStr}`;
            }

            getVtrColorClass(vtr) {
                const index = this.customVtrs.indexOf(vtr) % this.vtrColors.length;
                return this.vtrColors[index] || this.vtrColors[0];
            }

            applyFiltersAndRender() {
                this.renderOperationsTable();
            }

            clearFilters() {
                ['searchInput', 'vtrFilter', 'statusFilter', 'dateFromFilter', 'dateToFilter'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                this.renderOperationsTable();
            }

            // --- VTR and Location Management ---
            updateVtrDropdowns(selectId = 'vtrFilter') {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                const isFilter = selectId === 'vtrFilter';
                
                select.innerHTML = isFilter ? '<option value="">Todas as VTRs</option>' : '<option value="">Selecione uma VTR</option>';
                
                this.customVtrs.forEach(vtr => {
                    const option = document.createElement('option');
                    option.value = vtr;
                    option.textContent = vtr;
                    select.appendChild(option);
                });
                
                if (currentValue && this.customVtrs.includes(currentValue)) {
                    select.value = currentValue;
                }
            }

            updateLocationDatalist() {
                const datalist = document.getElementById('locationsList');
                if (!datalist) return;
                
                datalist.innerHTML = '';
                this.customLocations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location;
                    datalist.appendChild(option);
                });
            }

            addCustomVtr() {
                const input = document.getElementById('newVtrInput');
                const vtr = input.value.trim();
                
                if (vtr && !this.customVtrs.includes(vtr)) {
                    this.customVtrs.push(vtr);
                    input.value = '';
                    this.updateVtrDropdowns();
                    this.updateVtrDropdowns('operationModalVtr');
                    this.updateSettingsUI();
                    this.saveData();
                }
            }

            removeCustomVtr(vtr) {
                if (confirm(`Remover VTR "${vtr}"? Esta ação não pode ser desfeita.`)) {
                    this.customVtrs = this.customVtrs.filter(v => v !== vtr);
                    this.updateVtrDropdowns();
                    this.updateVtrDropdowns('operationModalVtr');
                    this.updateSettingsUI();
                    this.saveData();
                }
            }

            addCustomLocation() {
                const input = document.getElementById('newLocationInput');
                const location = input.value.trim();
                
                if (location && !this.customLocations.includes(location)) {
                    this.customLocations.push(location);
                    input.value = '';
                    this.updateLocationDatalist();
                    this.updateSettingsUI();
                    this.saveData();
                }
            }

            removeCustomLocation(location) {
                if (confirm(`Remover local "${location}"? Esta ação não pode ser desfeita.`)) {
                    this.customLocations = this.customLocations.filter(l => l !== location);
                    this.updateLocationDatalist();
                    this.updateSettingsUI();
                    this.saveData();
                }
            }

            updateSettingsUI() {
                this.renderCustomVtrsList();
                this.renderCustomLocationsList();
            }

            renderCustomVtrsList() {
                const container = document.getElementById('customVtrsListContainer');
                if (!container) return;
                
                container.innerHTML = this.customVtrs.map(vtr => `
                    <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                        <span class="text-gray-800 dark:text-gray-200">${vtr}</span>
                        <button onclick="fleetSystem.removeCustomVtr('${vtr}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            renderCustomLocationsList() {
                const container = document.getElementById('customLocationsListContainer');
                if (!container) return;
                
                container.innerHTML = this.customLocations.map(location => `
                    <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                        <span class="text-gray-800 dark:text-gray-200">${location}</span>
                        <button onclick="fleetSystem.removeCustomLocation('${location}')" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            // --- Conflicts Page ---
            renderConflictsPage() {
                const container = document.getElementById('conflictsListContainer');
                const conflictGroups = {};
                
                this.operations.forEach(operation => {
                    const conflicts = this.checkConflicts(operation);
                    if (conflicts.length > 0) {
                        const key = `${operation.vtr}-${operation.startDate}`;
                        if (!conflictGroups[key]) {
                            conflictGroups[key] = new Set();
                        }
                        conflictGroups[key].add(operation);
                        conflicts.forEach(conflict => conflictGroups[key].add(conflict));
                    }
                });
                
                if (Object.keys(conflictGroups).length === 0) {
                    container.innerHTML = '<div class="text-center py-8"><i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i><p class="text-lg text-green-600 dark:text-green-400">Nenhum conflito detectado!</p></div>';
                    return;
                }
                
                container.innerHTML = Object.entries(conflictGroups).map(([key, operationsSet]) => {
                    const operations = Array.from(operationsSet);
                    const [vtr, date] = key.split('-');
                    const formattedDate = new Date(date).toLocaleDateString('pt-BR');
                    
                    return `
                        <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg p-6">
                            <h3 class="font-semibold text-red-800 dark:text-red-200 mb-4 flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                Conflito: ${vtr} - ${formattedDate}
                            </h3>
                            <div class="space-y-3">
                                ${operations.map(op => `
                                    <div class="bg-white dark:bg-gray-800 border rounded-lg p-4">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h4 class="font-medium text-gray-900 dark:text-gray-100">${op.name}</h4>
                                                <p class="text-sm text-gray-600 dark:text-gray-400">${this.formatDisplayDateTime(op.startDate, op.startTime)} - ${this.formatDisplayDateTime(op.endDate, op.endTime)}</p>
                                                <p class="text-sm text-gray-500 dark:text-gray-500">Local: ${op.location}</p>
                                                ${op.observations ? `<p class="text-sm text-gray-500 dark:text-gray-500 mt-1">${op.observations}</p>` : ''}
                                            </div>
                                            <button onclick="fleetSystem.openOperationModal(fleetSystem.operations.find(o => o.id === '${op.id}'))" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // --- Calendar ---
            renderCalendar() {
                const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                
                document.getElementById('calendarMonthYear').textContent = `${monthNames[this.currentDisplayMonth]} ${this.currentDisplayYear}`;
                
                const firstDayOfMonth = new Date(this.currentDisplayYear, this.currentDisplayMonth, 1).getDay();
                const daysInMonth = new Date(this.currentDisplayYear, this.currentDisplayMonth + 1, 0).getDate();
                
                const grid = document.getElementById('calendarGrid');
                grid.innerHTML = '';
                
                // Header days
                dayNames.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'text-center font-semibold text-gray-600 dark:text-gray-400 py-2 text-sm';
                    dayHeader.textContent = day;
                    grid.appendChild(dayHeader);
                });
                
                // Empty cells for days before month starts
                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'p-2';
                    grid.appendChild(emptyDay);
                }
                
                // Days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'border border-gray-200 dark:border-gray-700 p-2 min-h-24 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
                    
                    const dateStr = `${this.currentDisplayYear}-${String(this.currentDisplayMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayOperations = this.operations.filter(op => op.startDate <= dateStr && op.endDate >= dateStr);
                    
                    dayCell.innerHTML = `
                        <div class="font-semibold text-sm mb-1">${day}</div>
                        ${dayOperations.slice(0, 3).map(op => {
                            const conflicts = this.checkConflicts(op);
                            const hasConflict = conflicts.length > 0;
                            return `<div class="text-xs p-1 mb-1 rounded ${hasConflict ? 'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-200'}" title="${op.name} - ${op.vtr}">${op.name.substring(0, 15)}${op.name.length > 15 ? '...' : ''}</div>`;
                        }).join('')}
                        ${dayOperations.length > 3 ? `<div class="text-xs text-gray-500 dark:text-gray-400">+${dayOperations.length - 3} mais</div>` : ''}
                    `;
                    
                    grid.appendChild(dayCell);
                }
            }

            changeMonth(direction) {
                this.currentDisplayMonth += direction;
                if (this.currentDisplayMonth < 0) {
                    this.currentDisplayMonth = 11;
                    this.currentDisplayYear--;
                } else if (this.currentDisplayMonth > 11) {
                    this.currentDisplayMonth = 0;
                    this.currentDisplayYear++;
                }
                this.renderCalendar();
            }

            // --- Statistics ---
            updateStatistics() {
                const totalOps = this.operations.length;
                const withConflicts = this.operations.filter(op => this.checkConflicts(op).length > 0).length;
                const withoutConflicts = totalOps - withConflicts;
                
                document.getElementById('statsTotalOperations').textContent = totalOps;
                document.getElementById('statsNoConflicts').textContent = withoutConflicts;
                document.getElementById('statsWithConflicts').textContent = withConflicts;
                
                // VTR usage statistics
                const vtrUsage = {};
                this.operations.forEach(op => {
                    vtrUsage[op.vtr] = (vtrUsage[op.vtr] || 0) + 1;
                });
                
                const topVtrs = Object.entries(vtrUsage)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                document.getElementById('statsVtrUsage').innerHTML = topVtrs.map(([vtr, count]) => `
                    <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                        <span class="font-medium">${vtr}</span>
                        <span class="bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-200 px-2 py-1 rounded">${count}</span>
                    </div>
                `).join('') || '<p class="text-gray-500 dark:text-gray-400">Nenhum dado disponível</p>';
                
                // Operation name statistics
                const nameUsage = {};
                this.operations.forEach(op => {
                    nameUsage[op.name] = (nameUsage[op.name] || 0) + 1;
                });
                
                const topNames = Object.entries(nameUsage)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                document.getElementById('statsOperationNames').innerHTML = topNames.map(([name, count]) => `
                    <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                        <span class="font-medium truncate mr-2" title="${name}">${name.length > 20 ? name.substring(0, 20) + '...' : name}</span>
                        <span class="bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-200 px-2 py-1 rounded">${count}</span>
                    </div>
                `).join('') || '<p class="text-gray-500 dark:text-gray-400">Nenhum dado disponível</p>';
            }

            // --- Data Export/Import ---
            exportCsv() {
                const headers = ['Nome/Descrição', 'Data Início', 'Hora Início', 'Data Término', 'Hora Término', 'VTR', 'Local', 'Status', 'Observações'];
                
                const csvContent = [
                    headers.join(','),
                    ...this.operations.map(op => {
                        const hasConflicts = this.checkConflicts(op).length > 0;
                        return [
                            `"${op.name.replace(/"/g, '""')}"`,
                            op.startDate,
                            op.startTime,
                            op.endDate,
                            op.endTime,
                            op.vtr,
                            `"${op.location.replace(/"/g, '""')}"`,
                            hasConflicts ? 'Com Conflito' : 'Sem Conflito',
                            `"${(op.observations || '').replace(/"/g, '""')}"`
                        ].join(',');
                    })
                ].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `operacoes_frota_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }

            exportData() {
                const data = {
                    operations: this.operations,
                    customVtrs: this.customVtrs,
                    customLocations: this.customLocations,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `backup_frota_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            }

            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.operations && data.customVtrs && data.customLocations) {
                            if (confirm('Esta ação irá substituir todos os dados atuais. Deseja continuar?')) {
                                this.operations = data.operations;
                                this.customVtrs = data.customVtrs;
                                this.customLocations = data.customLocations;
                                
                                this.saveData();
                                this.updateVtrDropdowns();
                                this.updateVtrDropdowns('operationModalVtr');
                                this.updateLocationDatalist();
                                this.renderOperationsTable();
                                this.updateStatistics();
                                this.updateSettingsUI();
                                
                                alert('Dados restaurados com sucesso!');
                                event.target.value = '';
                            }
                        } else {
                            alert('Arquivo de backup inválido.');
                        }
                    } catch (error) {
                        alert('Erro ao ler o arquivo de backup.');
                    }
                };
                
                reader.readAsText(file);
            }

            clearAllData() {
                if (confirm('Esta ação irá apagar TODOS os dados permanentemente. Deseja continuar?')) {
                    if (confirm('Tem CERTEZA? Esta ação não pode ser desfeita!')) {
                        this.operations = [];
                        this.customVtrs = ['VTR-001', 'VTR-002', 'VTR-003', 'VTR-004', 'VTR-005'];
                        this.customLocations = ['Centro da Cidade', 'Zona Industrial', 'Aeroporto', 'Porto', 'Rodovia BR-101'];
                        
                        this.saveData();
                        this.updateVtrDropdowns();
                        this.updateVtrDropdowns('operationModalVtr');
                        this.updateLocationDatalist();
                        this.renderOperationsTable();
                        this.updateStatistics();
                        this.updateSettingsUI();
                        
                        alert('Todos os dados foram apagados.');
                    }
                }
            }
        }

        // Initialize the system
        const fleetSystem = new FleetSystem();
    </script>
</body>
</html>