
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Frota - SGF</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-white { background-color: #2d3748; }
        .dark .text-gray-900 { color: #e2e8f0; }
        .dark .text-gray-600 { color: #a0aec0; }
        .dark .border-gray-200 { border-color: #4a5568; }
        .dark .bg-gray-50 { background-color: #2d3748; }
        .dark .bg-gray-100 { background-color: #4a5568; }
        .dark .bg-blue-50 { background-color: #2c5282; } /* Ajuste para modo escuro */
        .dark .bg-green-50 { background-color: #2f855a; } /* Ajuste para modo escuro */
        .dark .bg-red-50 { background-color: #c53030; } /* Ajuste para modo escuro */
        .dark .border-blue-200 { border-color: #63b3ed; } /* Ajuste para modo escuro */


        .sortable-ghost {
            opacity: 0.4;
            background: #f0f9ff;
        }
        
        .conflict {
            background-color: #fef2f2; /* Amarelo claro para conflito em modo claro */
        }
        
        .dark .conflict {
            background-color: #450a0a; /* Vermelho escuro para conflito em modo escuro */
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        @media print {
            body {
              -webkit-print-color-adjust: exact;
              print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            .print-table { font-size: 10px; width: 100%;}
            .print-table th, .print-table td {
                padding: 4px 6px;
                border: 1px solid #ccc;
            }
             main, #page-home, .overflow-x-auto, table {
                width: 100% !important;
                overflow: visible !important;
            }
            .bg-white { background-color: white !important; color: black !important; }
        }

        .page-transition {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-active {
            background-color: rgba(59, 130, 246, 0.1); /* Azul claro com opacidade */
            border-left: 3px solid #3b82f6; /* Borda azul */
        }
        .dark .nav-active {
            background-color: rgba(96, 165, 250, 0.2); /* Azul mais claro para dark mode */
            border-left: 3px solid #60a5fa;
        }


        .breadcrumb-item:not(:last-child)::after {
            content: " > ";
            color: #6b7280;
            margin: 0 8px;
        }
        .dark .breadcrumb-item:not(:last-child)::after {
            color: #a0aec0;
        }
        .dark .text-blue-600 { color: #60a5fa; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react-router-dom": "https://esm.sh/react-router-dom@^7.6.2",
    "react/": "https://esm.sh/react@^19.1.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-100 min-h-screen transition-colors duration-300">
    <!-- Header -->
    <header class="bg-blue-800 text-white shadow-lg sticky top-0 z-40 no-print">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <button id="homeButton" class="flex items-center space-x-3 hover:bg-blue-700 p-2 rounded transition-colors" title="Voltar ao Início">
                        <i class="fas fa-car text-2xl"></i>
                        <h1 class="text-2xl font-bold">Sistema de Gerenciamento de Frota</h1>
                    </button>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- Mobile Menu Button -->
                    <button id="mobileMenuToggle" class="md:hidden p-2 rounded hover:bg-blue-700 transition-colors">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <!-- Desktop Navigation -->
                    <nav class="hidden md:flex items-center space-x-2">
                        <button id="navHome" class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="home">
                            <i class="fas fa-home mr-1"></i>Início
                        </button>
                        <button id="navConflicts" class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="conflicts">
                            <i class="fas fa-exclamation-triangle mr-1"></i>Conflitos
                        </button>
                        <button id="navCalendar" class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="calendar">
                            <i class="fas fa-calendar mr-1"></i>Calendário
                        </button>
                        <button id="navStats" class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="stats">
                            <i class="fas fa-chart-bar mr-1"></i>Estatísticas
                        </button>
                        <button id="navBackup" class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="backup">
                            <i class="fas fa-database mr-1"></i>Backup
                        </button>
                        <button id="navSettings" class="nav-btn p-2 rounded hover:bg-blue-700 transition-colors" data-page="settings">
                            <i class="fas fa-cog mr-1"></i>Configurações
                        </button>
                    </nav>
                    
                    <button id="themeToggle" class="p-2 rounded hover:bg-blue-700 transition-colors">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Navigation Menu -->
        <div id="mobileMenu" class="md:hidden hidden bg-blue-700 border-t border-blue-600">
            <nav class="container mx-auto px-4 py-2 space-y-1">
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 transition-colors rounded" data-page="home">
                    <i class="fas fa-home mr-2"></i>Início
                </button>
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 transition-colors rounded" data-page="conflicts">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Conflitos
                </button>
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 transition-colors rounded" data-page="calendar">
                    <i class="fas fa-calendar mr-2"></i>Calendário
                </button>
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 transition-colors rounded" data-page="stats">
                    <i class="fas fa-chart-bar mr-2"></i>Estatísticas
                </button>
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 transition-colors rounded" data-page="backup">
                    <i class="fas fa-database mr-2"></i>Backup
                </button>
                <button class="nav-btn w-full text-left p-3 hover:bg-blue-600 transition-colors rounded" data-page="settings">
                    <i class="fas fa-cog mr-2"></i>Configurações
                </button>
            </nav>
        </div>
    </header>

    <!-- Breadcrumb Navigation -->
    <div id="breadcrumb" class="bg-white shadow-sm border-b no-print">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <nav class="flex items-center space-x-2 text-sm">
                    <span id="breadcrumbPath" class="flex items-center">
                        <!-- Breadcrumb items will be inserted here -->
                    </span>
                </nav>
                <div class="flex items-center space-x-2">
                    <button id="backButton" class="hidden px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                        <i class="fas fa-arrow-left mr-1"></i>Voltar
                    </button>
                    <button id="homeButtonSmall" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        <i class="fas fa-home mr-1"></i>Início
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <main class="container mx-auto px-4 py-6">
        
        <!-- HOME PAGE -->
        <div id="page-home" class="page-content page-transition">
            <!-- Toolbar -->
            <div class="bg-white shadow-sm border-b rounded-lg mb-6 no-print">
                <div class="px-6 py-4">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center space-x-4 flex-1 min-w-0"> <!-- Added min-w-0 for better wrapping -->
                            <div class="relative">
                                <input type="text" id="searchInput" placeholder="Buscar operação..." 
                                       class="pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <select id="vtrFilter" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Todas as VTRs</option>
                            </select>
                            <select id="statusFilter" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Todos os Status</option>
                                <option value="sem-conflito">Sem Conflito</option>
                                <option value="com-conflito">Com Conflito</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2 flex-wrap gap-2"> <!-- Added flex-wrap and gap-2 -->
                            <input type="date" id="dateFrom" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:[color-scheme:dark]">
                            <span class="text-gray-500">até</span>
                            <input type="date" id="dateTo" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:[color-scheme:dark]">
                            <button id="clearFilters" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                <i class="fas fa-eraser mr-2"></i>Limpar
                            </button>
                            <button id="exportCsvButton" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors">
                                <i class="fas fa-file-csv mr-2"></i>Exportar CSV
                            </button>
                            <button id="printButton" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-print mr-2"></i>Imprimir
                            </button>
                            <button id="addOperation" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Nova Operação
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operations Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full print-table">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider no-print"></th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nome/Descrição</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Data</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Início</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Término</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">VTR</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Local</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Observações</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider no-print">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="operationsTable" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                            <!-- Operations will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CONFLICTS PAGE -->
        <div id="page-conflicts" class="page-content hidden page-transition">
            <div class="bg-white rounded-lg shadow p-6 dark:bg-gray-800">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Resolução de Conflitos de Alocação de VTR</h2>
                <div id="conflictsList" class="space-y-6">
                    <!-- Conflicts will be listed here by JavaScript -->
                </div>
            </div>
        </div>


        <!-- CALENDAR PAGE -->
        <div id="page-calendar" class="page-content hidden page-transition">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-6">Calendário de Operações</h2>
                <div id="calendar" class="grid grid-cols-7 gap-2">
                    <!-- Calendar will be generated here -->
                </div>
            </div>
        </div>

        <!-- STATISTICS PAGE -->
        <div id="page-stats" class="page-content hidden page-transition">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-6">Estatísticas do Sistema</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <h3 class="font-semibold text-blue-800 dark:text-blue-300 mb-2">Total de Operações</h3>
                        <p id="totalOperations" class="text-4xl font-bold text-blue-600 dark:text-blue-400">0</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-lg">
                        <h3 class="font-semibold text-green-800 dark:text-green-300 mb-2">Sem Conflitos</h3>
                        <p id="noConflicts" class="text-4xl font-bold text-green-600 dark:text-green-400">0</p>
                    </div>
                    <div class="bg-red-50 p-6 rounded-lg">
                        <h3 class="font-semibold text-red-800 dark:text-red-300 mb-2">Com Conflitos</h3>
                        <p id="withConflicts" class="text-4xl font-bold text-red-600 dark:text-red-400">0</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">VTRs Mais Utilizadas</h3>
                        <div id="vtrStats" class="space-y-3">
                            <!-- VTR statistics will be shown here -->
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Operações por Tipo/Nome</h3>
                        <div id="operationTypeStats" class="space-y-3">
                            <!-- Operation type statistics will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BACKUP PAGE -->
        <div id="page-backup" class="page-content hidden page-transition">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-6">Gerenciamento de Dados</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4 text-green-600 dark:text-green-400">
                            <i class="fas fa-download mr-2"></i>Backup dos Dados
                        </h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-4">Faça backup de todas as operações, VTRs e locais em um arquivo JSON.</p>
                        <button id="exportData" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>Baixar Backup
                        </button>
                    </div>
                    <div class="border rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4 text-blue-600 dark:text-blue-400">
                            <i class="fas fa-upload mr-2"></i>Restaurar Dados
                        </h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-4">Restaure dados de um arquivo de backup anterior.</p>
                        <button id="importData" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-upload mr-2"></i>Carregar Backup
                        </button>
                        <input type="file" id="fileInput" class="hidden" accept=".json">
                    </div>
                </div>
                <div class="mt-8 border-t pt-6 dark:border-gray-700">
                    <div class="bg-red-50 dark:bg-red-800 dark:bg-opacity-30 border border-red-200 dark:border-red-700 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4 text-red-600 dark:text-red-400">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Zona de Perigo
                        </h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-4">Esta ação removerá permanentemente todas as operações, VTRs e locais personalizados do sistema.</p>
                        <button id="clearAllData" class="px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                            <i class="fas fa-trash mr-2"></i>Limpar Todos os Dados
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS PAGE -->
        <div id="page-settings" class="page-content hidden page-transition">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-2xl font-bold mb-6">Configurações do Sistema</h2>
                <div class="space-y-6">
                    <div class="border-b pb-6 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">Aparência</h3>
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="font-medium">Modo Escuro</label>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Alterar entre tema claro e escuro</p>
                            </div>
                            <button id="themeToggleSettings" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                                <i id="themeIcon" class="fas fa-moon mr-2"></i>
                                <span id="themeText">Ativar Modo Escuro</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="border-b pb-6 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">VTRs Personalizadas</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Adicionar Nova VTR</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="newVtrInput" placeholder="Nome da VTR" class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                    <button id="addVtrButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="customVtrsList" class="space-y-2">
                                <!-- Custom VTRs will be listed here -->
                            </div>
                        </div>
                    </div>

                    <div class="border-b pb-6 dark:border-gray-700">
                        <h3 class="text-lg font-semibold mb-4">Locais de Operação Personalizados</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Adicionar Novo Local</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="newLocationInput" placeholder="Nome do Local (Ex: Praça Central)" class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                                    <button id="addLocationButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="customLocationsList" class="space-y-2">
                                <!-- Custom Locations will be listed here -->
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Atalhos de Teclado</h3>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Nova Operação:</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-xs">Ctrl + N</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span>Voltar:</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-xs">Esc</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span>Ir para Início:</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-xs">Ctrl + H</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span>Buscar:</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-xs">Ctrl + F</kbd>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-4 mt-8 no-print">
        <div class="container mx-auto px-4 text-center">
            <p>&copy; <span id="currentYear"></span> Sistema de Gerenciamento de Frota - SPO-Lopes</p>
        </div>
    </footer>

    <!-- Operation Modal -->
    <div id="operationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 no-print">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="text-xl font-bold">Nova Operação</h2>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="operationForm" class="space-y-4">
                <input type="hidden" id="operationId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome/Descrição da Operação</label>
                        <input type="text" id="operationName" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data da Operação</label>
                        <input type="date" id="operationDate" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:[color-scheme:dark]">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">VTR</label>
                        <select id="operationVtr" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                            <option value="">Selecione uma VTR</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Hora de Início</label>
                        <input type="time" id="operationStartTime" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:[color-scheme:dark]">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Hora de Término</label>
                        <input type="time" id="operationEndTime" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:[color-scheme:dark]">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Local da Operação</label>
                        <input type="text" id="operationLocation" list="locationSuggestions" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600">
                        <datalist id="locationSuggestions">
                            <!-- Options will be populated by JavaScript -->
                        </datalist>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Observações</label>
                        <textarea id="operationObservations" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 pt-4">
                    <button type="button" id="cancelModal" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class FleetManagementSystem {
            constructor() {
                this.operations = [];
                this.currentPage = 'home';
                this.navigationHistory = ['home'];
                this.isDarkMode = false;
                this.vtrs = [ // Default VTRs
                    '1°PEL-VIATURA-9.6603',
                    '2°PEL-VTR-9.6623',
                    '4°PEL-VIATURA-9.6602',
                    'MOTO-SERTÃO'
                ];
                this.customVtrs = []; // User-added VTRs
                this.defaultLocations = [ // Default locations
                    'RUA L, FEIRA X, FEIRA DE SANTANA,BAHIA',
                    'RUA CRUZEIRO DO NORTE, CONCEIÇÃO, FEIRA DE SANTANA, BAHIA',
                    'JARDIM CRUZEIRO, FEIRA DE SANTANA, BAHIA',
                    'CAMPO LIMPO, FEIRA DE SANTANA, BAHIA',
                    'RUA CRUZEIRO DO NORDESTE, CONCEIÇÃO, FEIRA DE SANTANA, BAHIA'
                ];
                this.customLocations = []; // User-added locations
                
                this.pageNames = {
                    'home': 'Início',
                    'conflicts': 'Conflitos',
                    'calendar': 'Calendário',
                    'stats': 'Estatísticas',
                    'backup': 'Backup',
                    'settings': 'Configurações'
                };
                this.isDirty = false; // Track unsaved changes
                
                this.init();
            }

            init() {
                this.loadData(); // Load operations
                this.loadSettings(); // Load VTRs, Locations, Theme
                this.setupEventListeners();
                this.setupKeyboardShortcuts();
                this.renderOperations();
                this.updateVtrDropdowns();
                this.updateLocationDatalist();
                this.setupDragAndDrop();
                this.updateStatistics();
                this.updateBreadcrumb();
                this.updateNavigation();
                document.getElementById('currentYear').textContent = new Date().getFullYear();
            }

            setDirty(status = true) {
                this.isDirty = status;
            }

            handleBeforeUnload(event) {
                if (this.isDirty) {
                    event.preventDefault(); 
                    event.returnValue = 'Você tem alterações não salvas. Tem certeza que deseja sair? Considere fazer um backup.'; 
                    return 'Você tem alterações não salvas. Tem certeza que deseja sair? Considere fazer um backup.';
                }
            }

            setupEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const page = e.currentTarget.getAttribute('data-page');
                        this.showPage(page);
                    });
                });

                document.getElementById('homeButton').addEventListener('click', () => this.goToHome());
                document.getElementById('homeButtonSmall').addEventListener('click', () => this.goToHome());
                document.getElementById('backButton').addEventListener('click', () => this.goBack());
                document.getElementById('mobileMenuToggle').addEventListener('click', () => this.toggleMobileMenu());

                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());
                document.getElementById('themeToggleSettings').addEventListener('click', () => this.toggleTheme());
                
                // Data management
                document.getElementById('exportData').addEventListener('click', () => this.exportData());
                document.getElementById('importData').addEventListener('click', () => this.importData());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileImport(e));
                document.getElementById('clearAllData').addEventListener('click', () => this.clearAllData());
                
                // VTR management
                document.getElementById('addVtrButton').addEventListener('click', () => this.addCustomVtr());
                document.getElementById('newVtrInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addCustomVtr();
                });

                // Location management
                document.getElementById('addLocationButton').addEventListener('click', () => this.addCustomLocation());
                document.getElementById('newLocationInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addCustomLocation();
                });
                
                // Modal
                document.getElementById('addOperation').addEventListener('click', () => this.openModal());
                document.getElementById('closeModal').addEventListener('click', () => this.closeModal());
                document.getElementById('cancelModal').addEventListener('click', () => this.closeModal());
                document.getElementById('operationForm').addEventListener('submit', (e) => this.saveOperation(e));
                
                // Filters & Actions
                document.getElementById('searchInput').addEventListener('input', () => this.applyFilters());
                document.getElementById('vtrFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('statusFilter').addEventListener('change', () => this.applyFilters());
                document.getElementById('dateFrom').addEventListener('change', () => this.applyFilters());
                document.getElementById('dateTo').addEventListener('change', () => this.applyFilters());
                document.getElementById('clearFilters').addEventListener('click', () => this.clearFilters());
                document.getElementById('printButton').addEventListener('click', () => this.printTable());
                document.getElementById('exportCsvButton').addEventListener('click', () => this.exportTableToCSV());


                // Unsaved changes listener
                window.addEventListener('beforeunload', this.handleBeforeUnload.bind(this));
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key.toLowerCase()) { 
                            case 'n':
                                e.preventDefault();
                                if (this.currentPage === 'home') this.openModal();
                                break;
                            case 'h':
                                e.preventDefault();
                                this.goToHome();
                                break;
                            case 'f':
                                e.preventDefault();
                                if (this.currentPage === 'home') {
                                    document.getElementById('searchInput').focus();
                                }
                                break;
                        }
                    } else if (e.key === 'Escape') {
                        if (document.getElementById('operationModal').classList.contains('flex')) {
                            this.closeModal();
                        } else if (this.currentPage !== 'home' && this.navigationHistory.length > 1) {
                            this.goBack();
                        }
                    }
                });
            }

            showPage(pageId) {
                if (pageId === this.currentPage && document.getElementById(`page-${pageId}`) && !document.getElementById(`page-${pageId}`).classList.contains('hidden')) return;
                
                document.querySelectorAll('.page-content').forEach(page => {
                    page.classList.add('hidden');
                });
                
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    targetPage.classList.add('page-transition'); // Ensure animation class is present
                    
                    if (this.navigationHistory[this.navigationHistory.length - 1] !== pageId) {
                        this.navigationHistory.push(pageId);
                    }
                    
                    this.currentPage = pageId;
                    this.updateBreadcrumb();
                    this.updateNavigation();
                    this.closeMobileMenu();
                    
                    this.loadPageContent(pageId);
                }
            }

            goToHome() {
                this.navigationHistory = ['home']; 
                this.showPage('home');
            }

            goBack() {
                if (this.navigationHistory.length > 1) {
                    this.navigationHistory.pop(); 
                    const previousPage = this.navigationHistory[this.navigationHistory.length - 1];
                    this.currentPage = previousPage; 
                    this.showPage(previousPage); 
                }
            }


            loadPageContent(pageId) {
                switch(pageId) {
                    case 'calendar':
                        this.renderCalendar();
                        break;
                    case 'stats':
                        this.updateStatistics();
                        break;
                    case 'settings':
                        this.updateSettingsPage();
                        break;
                    case 'conflicts':
                        this.renderConflictsPage();
                        break;
                }
            }

            updateBreadcrumb() {
                const breadcrumbPath = document.getElementById('breadcrumbPath');
                const backButton = document.getElementById('backButton');
                
                let breadcrumbHTML = '';
                this.navigationHistory.forEach((pageId, index) => {
                    const pageName = this.pageNames[pageId] || pageId;
                    if (index === this.navigationHistory.length - 1) {
                        breadcrumbHTML += `<span class="breadcrumb-item font-semibold text-blue-600 dark:text-blue-400">${pageName}</span>`;
                    } else {
                        breadcrumbHTML += `<button class="breadcrumb-item text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400" onclick="fleetSystem.navigateToBreadcrumb(${index})">${pageName}</button>`;
                    }
                });
                
                breadcrumbPath.innerHTML = breadcrumbHTML;
                
                backButton.classList.toggle('hidden', this.navigationHistory.length <= 1);
            }

            navigateToBreadcrumb(index) {
                this.navigationHistory = this.navigationHistory.slice(0, index + 1);
                const targetPage = this.navigationHistory[index];
                this.currentPage = targetPage; 
                this.showPage(targetPage);
            }

            updateNavigation() {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('nav-active');
                    if (btn.getAttribute('data-page') === this.currentPage) {
                        btn.classList.add('nav-active');
                    }
                });
            }

            toggleMobileMenu() {
                document.getElementById('mobileMenu').classList.toggle('hidden');
            }

            closeMobileMenu() {
                document.getElementById('mobileMenu').classList.add('hidden');
            }

            loadData() { 
                const stored = localStorage.getItem('fleetOperations');
                if (stored) {
                    this.operations = JSON.parse(stored);
                } else {
                    this.operations = [
                        {
                            id: this.generateId(),
                            name: 'SATURAÇÃO EXEMPLO',
                            date: new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().split('T')[0], // Tomorrow
                            startTime: '12:00',
                            endTime: '18:00',
                            vtr: this.vtrs[0] || 'VTR_PADRAO_1',
                            location: this.defaultLocations[0] || 'LOCAL_PADRAO_1',
                            observations: 'Operação de exemplo.',
                            order: 0
                        }
                    ];
                    this.saveData(); 
                }
                this.setDirty(false); 
            }

            loadSettings() { 
                const stored = localStorage.getItem('fleetSettings');
                if (stored) {
                    const settings = JSON.parse(stored);
                    this.isDarkMode = settings.isDarkMode || false;
                    this.customVtrs = settings.customVtrs || [];
                    this.customLocations = settings.customLocations || [];
                }
                
                document.documentElement.classList.toggle('dark', this.isDarkMode);
                this.updateThemeButtons();
                this.setDirty(false); 
            }

            saveData() { 
                localStorage.setItem('fleetOperations', JSON.stringify(this.operations));
                this.setDirty(true);
            }

            saveSettings() { 
                const settings = {
                    isDarkMode: this.isDarkMode,
                    customVtrs: this.customVtrs,
                    customLocations: this.customLocations,
                };
                localStorage.setItem('fleetSettings', JSON.stringify(settings));
                this.setDirty(true);
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            toggleTheme() {
                this.isDarkMode = !this.isDarkMode;
                document.documentElement.classList.toggle('dark', this.isDarkMode);
                this.updateThemeButtons();
                this.saveSettings(); 
            }

            updateThemeButtons() {
                const icon = document.querySelector('#themeToggle i');
                const settingsIcon = document.getElementById('themeIcon');
                const settingsText = document.getElementById('themeText');
                
                if (this.isDarkMode) {
                    icon.className = 'fas fa-sun';
                    if (settingsIcon) settingsIcon.className = 'fas fa-sun mr-2';
                    if (settingsText) settingsText.textContent = 'Desativar Modo Escuro';
                } else {
                    icon.className = 'fas fa-moon';
                    if (settingsIcon) settingsIcon.className = 'fas fa-moon mr-2';
                    if (settingsText) settingsText.textContent = 'Ativar Modo Escuro';
                }
            }

            exportData() {
                const backupData = {
                    operations: this.operations,
                    settings: {
                        isDarkMode: this.isDarkMode,
                        customVtrs: this.customVtrs,
                        customLocations: this.customLocations
                    }
                };
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `frota_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                this.setDirty(false); 
                alert('Backup realizado com sucesso!');
            }

            importData() {
                document.getElementById('fileInput').click();
            }

            handleFileImport(e) {
                const file = e.target.files[0];
                if (file && file.type === 'application/json') {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if (confirm('Isso substituirá todos os dados atuais (operações, VTRs e locais personalizados). Continuar?')) {
                                if (data.operations) this.operations = data.operations;
                                if (data.settings) {
                                    this.isDarkMode = data.settings.isDarkMode || false;
                                    this.customVtrs = data.settings.customVtrs || [];
                                    this.customLocations = data.settings.customLocations || [];
                                }
                                this.saveData();
                                this.saveSettings();
                                this.loadSettings(); 
                                this.renderOperations();
                                this.updateVtrDropdowns();
                                this.updateLocationDatalist();
                                this.updateStatistics();
                                if (this.currentPage === 'conflicts') this.renderConflictsPage();
                                this.setDirty(false); 
                                alert('Dados importados com sucesso!');
                            }
                        } catch (error) {
                            console.error("Erro ao importar:", error);
                            alert('Erro ao importar arquivo. Verifique se é um arquivo JSON válido e no formato esperado.');
                        }
                    };
                    reader.readAsText(file);
                    e.target.value = null; 
                }
            }

            clearAllData() {
                if (confirm('ATENÇÃO: Isso removerá permanentemente TODAS as operações, VTRs e locais personalizados. Esta ação não pode ser desfeita. Continuar?')) {
                    if (confirm('Tem certeza absoluta? Todos os dados serão perdidos!')) {
                        this.operations = [];
                        this.customVtrs = [];
                        this.customLocations = [];
                        this.saveData(); 
                        this.saveSettings(); 
                        
                        this.renderOperations();
                        this.updateVtrDropdowns();
                        this.updateLocationDatalist();
                        this.updateStatistics();
                        this.updateSettingsPage(); 
                        if (this.currentPage === 'conflicts') this.renderConflictsPage();
                        this.setDirty(false); 
                        alert('Todos os dados foram removidos.');
                    }
                }
            }

            addCustomVtr() {
                const input = document.getElementById('newVtrInput');
                const vtrName = input.value.trim().toUpperCase();
                
                if (vtrName && !this.getAllVtrs().includes(vtrName)) {
                    this.customVtrs.push(vtrName);
                    this.saveSettings();
                    this.updateVtrDropdowns();
                    this.updateCustomVtrsList();
                    input.value = '';
                } else if (this.getAllVtrs().includes(vtrName)) {
                    alert('Esta VTR já existe!');
                } else if (!vtrName) {
                    alert('O nome da VTR não pode ser vazio.');
                }
            }

            removeCustomVtr(vtrName) {
                if (confirm(`Remover VTR "${vtrName}"? Se esta VTR estiver em uso em operações, será necessário atualizá-las.`)) {
                    this.customVtrs = this.customVtrs.filter(vtr => vtr !== vtrName);
                    this.saveSettings();
                    this.updateVtrDropdowns();
                    this.updateCustomVtrsList();
                }
            }

            getAllVtrs() {
                return [...new Set([...this.vtrs, ...this.customVtrs])].sort();
            }

            updateCustomVtrsList() {
                const container = document.getElementById('customVtrsList');
                if (!container) return;
                
                container.innerHTML = this.customVtrs.sort().map(vtr => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-600 rounded">
                        <span>${vtr}</span>
                        <button onclick="fleetSystem.removeCustomVtr('${vtr}')" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300" title="Remover VTR">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            addCustomLocation() {
                const input = document.getElementById('newLocationInput');
                const locationName = input.value.trim();
                
                if (locationName && !this.getAllLocations().map(l => l.toUpperCase()).includes(locationName.toUpperCase())) {
                    this.customLocations.push(locationName);
                    this.saveSettings();
                    this.updateLocationDatalist();
                    this.updateCustomLocationsList();
                    input.value = '';
                } else if (this.getAllLocations().map(l => l.toUpperCase()).includes(locationName.toUpperCase())) {
                    alert('Este Local já existe!');
                } else if (!locationName) {
                     alert('O nome do Local não pode ser vazio.');
                }
            }

            removeCustomLocation(locationName) {
                if (confirm(`Remover Local "${locationName}"? Se este local estiver em uso em operações, será necessário atualizá-las.`)) {
                    this.customLocations = this.customLocations.filter(loc => loc !== locationName);
                    this.saveSettings();
                    this.updateLocationDatalist();
                    this.updateCustomLocationsList();
                }
            }

            getAllLocations() { 
                return [...new Set([...this.defaultLocations, ...this.customLocations])].sort();
            }

            updateCustomLocationsList() {
                const container = document.getElementById('customLocationsList');
                if (!container) return;
                
                container.innerHTML = this.customLocations.sort().map(loc => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-600 rounded">
                        <span>${loc}</span>
                        <button onclick="fleetSystem.removeCustomLocation('${loc}')" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300" title="Remover Local">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            updateLocationDatalist() {
                const datalist = document.getElementById('locationSuggestions');
                if (!datalist) return;
                datalist.innerHTML = this.getAllLocations().map(loc => `<option value="${loc}"></option>`).join('');
            }


            updateSettingsPage() {
                this.updateCustomVtrsList();
                this.updateCustomLocationsList();
                this.updateThemeButtons(); 
            }

            openModal(operation = null) {
                const modal = document.getElementById('operationModal');
                const title = document.getElementById('modalTitle');
                const form = document.getElementById('operationForm');
                
                this.updateVtrDropdown(); 
                this.updateLocationDatalist(); 

                if (operation) {
                    title.textContent = 'Editar Operação';
                    document.getElementById('operationId').value = operation.id;
                    document.getElementById('operationName').value = operation.name;
                    document.getElementById('operationDate').value = operation.date;
                    document.getElementById('operationStartTime').value = operation.startTime;
                    document.getElementById('operationEndTime').value = operation.endTime;
                    document.getElementById('operationVtr').value = operation.vtr;
                    document.getElementById('operationLocation').value = operation.location;
                    document.getElementById('operationObservations').value = operation.observations;
                } else {
                    title.textContent = 'Nova Operação';
                    form.reset();
                    document.getElementById('operationId').value = '';
                    document.getElementById('operationDate').value = new Date().toISOString().split('T')[0];
                }
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.getElementById('operationName').focus(); 
            }

            closeModal() {
                const modal = document.getElementById('operationModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                 if (this.currentPage === 'conflicts') { // Refresh conflicts page after modal close
                    this.renderConflictsPage();
                }
            }

            saveOperation(e) {
                e.preventDefault();
                
                const id = document.getElementById('operationId').value;
                const operationData = {
                    id: id || this.generateId(),
                    name: document.getElementById('operationName').value.trim(),
                    date: document.getElementById('operationDate').value,
                    startTime: document.getElementById('operationStartTime').value,
                    endTime: document.getElementById('operationEndTime').value,
                    vtr: document.getElementById('operationVtr').value,
                    location: document.getElementById('operationLocation').value.trim(),
                    observations: document.getElementById('operationObservations').value.trim(),
                    order: id ? (this.operations.find(op => op.id === id)?.order ?? this.operations.length) : (this.operations.length > 0 ? Math.max(...this.operations.map(op => op.order)) + 1 : 0)
                };

                if (!operationData.name || !operationData.date || !operationData.startTime || !operationData.endTime || !operationData.vtr || !operationData.location) {
                    alert("Por favor, preencha todos os campos obrigatórios.");
                    return;
                }
                if (operationData.endTime <= operationData.startTime) {
                    alert("A hora de término deve ser posterior à hora de início.");
                    return;
                }

                if (id) {
                    const index = this.operations.findIndex(op => op.id === id);
                    this.operations[index] = operationData;
                } else {
                    this.operations.push(operationData);
                }

                this.saveData();
                this.renderOperations();
                this.updateStatistics();
                this.closeModal(); 
            }

            duplicateOperation(operationToDuplicate) {
                const newOperation = {
                    ...operationToDuplicate, // Spread existing operation
                    id: '', // Clear ID for new operation, openModal will handle new ID if saved
                    name: operationToDuplicate.name + ' (Cópia)',
                    date: new Date().toISOString().split('T')[0], // Default to today
                    startTime: operationToDuplicate.startTime, // Keep original times as a starting point
                    endTime: operationToDuplicate.endTime,
                    order: (this.operations.length > 0 ? Math.max(...this.operations.map(op => op.order)) + 1 : 0) // New order
                };
                this.openModal(newOperation); // Open modal with this pre-filled new operation
            }

            deleteOperation(id) {
                if (confirm('Tem certeza que deseja excluir esta operação?')) {
                    this.operations = this.operations.filter(op => op.id !== id);
                    this.saveData();
                    this.renderOperations();
                    this.updateStatistics();
                     if (this.currentPage === 'conflicts') {
                        this.renderConflictsPage();
                    }
                }
            }

            checkConflicts(operation) {
                return this.operations.filter(op => 
                    op.id !== operation.id &&
                    op.vtr === operation.vtr &&
                    op.date === operation.date &&
                    this.timeOverlap(op.startTime, op.endTime, operation.startTime, operation.endTime)
                );
            }

            timeOverlap(start1, end1, start2, end2) {
                if (!start1 || !end1 || !start2 || !end2) return false;
                return start1 < end2 && start2 < end1;
            }

            renderOperations() {
                const tbody = document.getElementById('operationsTable');
                const filteredOps = this.getFilteredOperations();
                
                if (filteredOps.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500 dark:text-gray-400">Nenhuma operação encontrada.</td></tr>`;
                    return;
                }

                tbody.innerHTML = filteredOps.map(operation => {
                    const conflicts = this.checkConflicts(operation);
                    const hasConflict = conflicts.length > 0;
                    
                    return `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 ${hasConflict ? 'conflict' : ''}" data-id="${operation.id}">
                            <td class="px-4 py-3 no-print">
                                <i class="fas fa-grip-vertical text-gray-400 dark:text-gray-500 cursor-grab" title="Arraste para reordenar"></i>
                            </td>
                            <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100">${operation.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300">${this.formatDate(operation.date)}</td>
                            <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300">${operation.startTime}</td>
                            <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300">${operation.endTime}</td>
                            <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${this.getVtrColorClass(operation.vtr)}">
                                    ${operation.vtr}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300 max-w-xs truncate" title="${operation.location}">
                                ${operation.location}
                            </td>
                            <td class="px-4 py-3 text-sm text-center">
                                ${hasConflict ? 
                                    `<div class="tooltip">
                                        <i class="fas fa-exclamation-triangle text-red-500 dark:text-red-400"></i>
                                        <span class="tooltiptext">Conflito com: ${conflicts.map(c => `${c.name} (${c.startTime}-${c.endTime})`).join(', ')}</span>
                                    </div>` : 
                                    '<i class="fas fa-check-circle text-green-500 dark:text-green-400"></i>'
                                }
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-300 max-w-xs truncate" title="${operation.observations}">
                                ${operation.observations || '-'}
                            </td>
                            <td class="px-4 py-3 text-sm font-medium no-print">
                                <div class="flex space-x-2">
                                    <button onclick="fleetSystem.openModal(JSON.parse(JSON.stringify(fleetSystem.operations.find(op => op.id === '${operation.id}'))))" 
                                            class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="fleetSystem.duplicateOperation(JSON.parse(JSON.stringify(fleetSystem.operations.find(op => op.id === '${operation.id}'))))"
                                            class="text-yellow-500 hover:text-yellow-700 dark:text-yellow-400 dark:hover:text-yellow-300" title="Duplicar">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button onclick="fleetSystem.deleteOperation('${operation.id}')" 
                                            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            getFilteredOperations() {
                let filtered = [...this.operations];
                
                const search = document.getElementById('searchInput').value.toLowerCase();
                const vtrFilterValue = document.getElementById('vtrFilter').value;
                const statusFilterValue = document.getElementById('statusFilter').value;
                const dateFromValue = document.getElementById('dateFrom').value;
                const dateToValue = document.getElementById('dateTo').value;
                
                if (search) {
                    filtered = filtered.filter(op => 
                        op.name.toLowerCase().includes(search) ||
                        op.location.toLowerCase().includes(search) ||
                        op.vtr.toLowerCase().includes(search) ||
                        op.observations.toLowerCase().includes(search)
                    );
                }
                
                if (vtrFilterValue) {
                    filtered = filtered.filter(op => op.vtr === vtrFilterValue);
                }
                
                if (statusFilterValue) {
                    filtered = filtered.filter(op => {
                        const hasConflict = this.checkConflicts(op).length > 0;
                        return statusFilterValue === 'com-conflito' ? hasConflict : !hasConflict;
                    });
                }
                
                if (dateFromValue) {
                    filtered = filtered.filter(op => op.date >= dateFromValue);
                }
                
                if (dateToValue) {
                    filtered = filtered.filter(op => op.date <= dateToValue);
                }
                
                return filtered.sort((a, b) => a.order - b.order);
            }

            applyFilters() {
                if (this.currentPage === 'home') {
                    this.renderOperations();
                }
            }

            clearFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('vtrFilter').value = '';
                document.getElementById('statusFilter').value = '';
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                this.renderOperations();
            }

            printTable() {
                window.print();
            }

            escapeCSVValue(value) {
                if (value == null) return '';
                const stringValue = String(value);
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n') || stringValue.includes('\r')) {
                    return `"${stringValue.replace(/"/g, '""')}"`;
                }
                return stringValue;
            }

            exportTableToCSV() {
                const operationsToExport = this.getFilteredOperations();
                if (operationsToExport.length === 0) {
                    alert("Nenhuma operação para exportar.");
                    return;
                }

                const headers = [
                    "Nome/Descrição", "Data", "Início", "Término",
                    "VTR", "Local", "Status Conflito", "Observações"
                ];
                
                const csvRows = [
                    headers.join(','), 
                    ...operationsToExport.map(op => {
                        const conflictsDetails = this.checkConflicts(op);
                        const statusConflict = conflictsDetails.length > 0 
                            ? `Com Conflito: ${conflictsDetails.map(c => c.name).join('; ')}` 
                            : "Sem Conflito";
                        return [
                            this.escapeCSVValue(op.name),
                            this.escapeCSVValue(this.formatDate(op.date)),
                            this.escapeCSVValue(op.startTime),
                            this.escapeCSVValue(op.endTime),
                            this.escapeCSVValue(op.vtr),
                            this.escapeCSVValue(op.location),
                            this.escapeCSVValue(statusConflict),
                            this.escapeCSVValue(op.observations)
                        ].join(',');
                    })
                ];

                const csvString = csvRows.join('\n');
                const blob = new Blob(["\uFEFF" + csvString], { type: 'text/csv;charset=utf-8;' }); // Added BOM for Excel
                const link = document.createElement("a");
                
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `operacoes_frota_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert("Dados exportados para CSV com sucesso!");
            }


            formatDate(dateStr) {
                if (!dateStr) return '';
                const parts = dateStr.split('-');
                const date = new Date(parts[0], parts[1] - 1, parts[2]);
                return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' }); 
            }

            getVtrColorClass(vtr) { 
                let hash = 0;
                for (let i = 0; i < vtr.length; i++) {
                    hash = vtr.charCodeAt(i) + ((hash << 5) - hash);
                }
                const colorIndex = Math.abs(hash % 5); 
                
                const vtrColorClasses = [
                    'bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-200',
                    'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-200',
                    'bg-purple-100 text-purple-800 dark:bg-purple-700 dark:text-purple-200',
                    'bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-200', // Changed orange to yellow
                    'bg-pink-100 text-pink-800 dark:bg-pink-700 dark:text-pink-200',
                ];
                const defaultVtrColors = {
                    '1°PEL-VIATURA-9.6603': 'bg-sky-100 text-sky-800 dark:bg-sky-700 dark:text-sky-200',
                    '2°PEL-VTR-9.6623': 'bg-emerald-100 text-emerald-800 dark:bg-emerald-700 dark:text-emerald-200',
                    '4°PEL-VIATURA-9.6602': 'bg-violet-100 text-violet-800 dark:bg-violet-700 dark:text-violet-200',
                    'MOTO-SERTÃO': 'bg-amber-100 text-amber-800 dark:bg-amber-700 dark:text-amber-200'
                };

                return defaultVtrColors[vtr] || vtrColorClasses[colorIndex];
            }


            updateVtrDropdowns() { 
                const allVtrs = this.getAllVtrs();
                const filterSelect = document.getElementById('vtrFilter');
                const currentFilterValue = filterSelect.value; 
                
                filterSelect.innerHTML = '<option value="">Todas as VTRs</option>' +
                    allVtrs.map(vtr => `<option value="${vtr}">${vtr}</option>`).join('');
                
                if (allVtrs.includes(currentFilterValue)) {
                    filterSelect.value = currentFilterValue;
                } else {
                    filterSelect.value = ""; 
                }
            }

            updateVtrDropdown() { 
                const select = document.getElementById('operationVtr');
                const allVtrs = this.getAllVtrs();
                const currentValue = select.value; 
                
                select.innerHTML = '<option value="">Selecione uma VTR</option>' +
                    allVtrs.map(vtr => `<option value="${vtr}">${vtr}</option>`).join('');

                if (allVtrs.includes(currentValue)) {
                     select.value = currentValue;
                } else {
                    select.value = ""; 
                }
            }

            setupDragAndDrop() {
                const tbody = document.getElementById('operationsTable');
                Sortable.create(tbody, {
                    handle: '.fa-grip-vertical',
                    ghostClass: 'sortable-ghost',
                    animation: 150,
                    onEnd: (evt) => {
                        const idOrderInTable = Array.from(tbody.children).map(row => row.dataset.id);
                        
                        // Create a map of operations for quick lookup
                        const operationMap = new Map(this.operations.map(op => [op.id, op]));
                        
                        // Create a new sorted list based on the visual order in the table
                        const reorderedOperations = [];
                        idOrderInTable.forEach(id => {
                            if (operationMap.has(id)) {
                                reorderedOperations.push(operationMap.get(id));
                            }
                        });

                        // Add back any operations that were filtered out, maintaining their original relative order at the end
                        this.operations.forEach(op => {
                            if (!idOrderInTable.includes(op.id)) {
                                reorderedOperations.push(op);
                            }
                        });
                        
                        // Re-assign 'order' property based on the new full list order
                        reorderedOperations.forEach((op, index) => {
                            op.order = index;
                        });

                        this.operations = reorderedOperations; // Update the main operations array
                        this.saveData();
                        this.renderOperations(); // Re-render to ensure consistency if any complex filtering was involved
                    }
                });
            }

            renderConflictsPage() {
                const conflictsListDiv = document.getElementById('conflictsList');
                if (!conflictsListDiv) return;

                const allConflictGroups = new Map(); // Key: "vtr-date", Value: { vtr, date, operations: [op1, op2,...] }

                this.operations.forEach(op => {
                    const conflictingOps = this.checkConflicts(op);
                    if (conflictingOps.length > 0) {
                        const involvedOps = [op, ...conflictingOps].sort((a,b) => a.startTime.localeCompare(b.startTime));
                        // Normalize by finding the earliest start and latest end time of the conflict group for display
                        const earliestStart = involvedOps.reduce((min, o) => o.startTime < min ? o.startTime : min, '23:59');
                        const latestEnd = involvedOps.reduce((max, o) => o.endTime > max ? o.endTime : max, '00:00');

                        const groupKey = `${op.vtr}-${op.date}-${earliestStart}-${latestEnd}`; // More specific key

                        if (!allConflictGroups.has(groupKey)) {
                            allConflictGroups.set(groupKey, {
                                vtr: op.vtr,
                                date: op.date,
                                startTime: earliestStart,
                                endTime: latestEnd,
                                operations: new Set() // Use Set to avoid duplicates if op is checked multiple times
                            });
                        }
                        const group = allConflictGroups.get(groupKey);
                        involvedOps.forEach(involvedOp => group.operations.add(involvedOp));
                    }
                });
                
                if (allConflictGroups.size === 0) {
                    conflictsListDiv.innerHTML = '<p class="text-gray-600 dark:text-gray-400">Nenhum conflito de VTR encontrado.</p>';
                    return;
                }

                let html = '';
                for (const [key, group] of allConflictGroups) {
                    const uniqueOperations = Array.from(group.operations).sort((a,b) => a.startTime.localeCompare(b.startTime));
                    if (uniqueOperations.length < 2) continue; // Skip if somehow a group ended up with less than 2 ops

                    html += `
                        <div class="mb-6 p-4 border rounded-lg dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                            <h3 class="text-lg font-semibold mb-3 text-red-600 dark:text-red-400">
                                <i class="fas fa-exclamation-circle mr-2"></i>Conflito em ${this.formatDate(group.date)} para VTR: 
                                <span class="px-2 py-1 text-sm font-semibold rounded-full ${this.getVtrColorClass(group.vtr)}">${group.vtr}</span>
                            </h3>
                            <div class="space-y-2">`;
                    
                    uniqueOperations.forEach(confOp => {
                        html += `
                                <div class="flex flex-wrap items-center justify-between p-3 border-b dark:border-gray-600 last:border-b-0">
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium text-gray-800 dark:text-gray-100 truncate" title="${confOp.name}">${confOp.name}</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">
                                            Horário: ${confOp.startTime} - ${confOp.endTime} | Local: <span class="truncate" title="${confOp.location}">${confOp.location}</span>
                                        </p>
                                    </div>
                                    <button onclick="fleetSystem.openModal(JSON.parse(JSON.stringify(fleetSystem.operations.find(op => op.id === '${confOp.id}'))))"
                                            class="ml-4 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm">
                                        <i class="fas fa-edit mr-1"></i>Editar
                                    </button>
                                </div>`;
                    });
                    html += `</div></div>`;
                }
                conflictsListDiv.innerHTML = html || '<p class="text-gray-600 dark:text-gray-400">Nenhum conflito de VTR encontrado após agrupamento.</p>'; // Fallback
            }


            renderCalendar() {
                const calendarEl = document.getElementById('calendar');
                if (!calendarEl) return;

                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth(); 

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                
                const daysInMonth = lastDayOfMonth.getDate();
                const startingDayOfWeek = firstDayOfMonth.getDay(); 

                let calendarHTML = `<div class="text-center font-bold col-span-7 mb-4 text-xl">
                    ${new Date(year, month).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase()}
                    </div>`;
                
                const dayHeaders = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                dayHeaders.forEach(day => {
                    calendarHTML += `<div class="text-center font-semibold p-2 md:p-3 bg-gray-100 dark:bg-gray-700 rounded">${day}</div>`;
                });
                
                for (let i = 0; i < startingDayOfWeek; i++) {
                    calendarHTML += '<div></div>'; 
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayOperations = this.operations.filter(op => op.date === currentDateStr);
                    
                    let dayClasses = "border-2 p-2 md:p-3 h-24 md:h-28 rounded-lg hover:shadow-md transition-shadow overflow-hidden ";
                    if (dayOperations.length > 0) {
                        dayClasses += "bg-blue-50 dark:bg-blue-800 border-blue-200 dark:border-blue-600";
                    } else {
                        dayClasses += "border-gray-200 dark:border-gray-600";
                    }
                    if (year === new Date().getFullYear() && month === new Date().getMonth() && day === new Date().getDate()){
                        dayClasses += " ring-2 ring-blue-500"; 
                    }

                    calendarHTML += `
                        <div class="${dayClasses}">
                            <div class="font-semibold text-lg mb-1">${day}</div>
                            <div class="text-xs space-y-1">
                                ${dayOperations.slice(0, 2).map(op => 
                                    `<div class="truncate bg-blue-100 dark:bg-blue-700 dark:text-blue-200 text-blue-700 px-1 rounded" title="${op.name} (${op.vtr})">${op.name}</div>`
                                ).join('')}
                                ${dayOperations.length > 2 ? `<div class="text-gray-500 dark:text-gray-400 text-xs">+${dayOperations.length - 2} mais</div>` : ''}
                            </div>
                        </div>
                    `;
                }
                calendarEl.innerHTML = calendarHTML;
            }

            updateStatistics() {
                const total = this.operations.length;
                const withConflictsCount = this.operations.filter(op => this.checkConflicts(op).length > 0).length;
                const noConflictsCount = total - withConflictsCount;
                
                document.getElementById('totalOperations').textContent = total;
                document.getElementById('noConflicts').textContent = noConflictsCount;
                document.getElementById('withConflicts').textContent = withConflictsCount;
                
                const vtrCounts = {};
                this.operations.forEach(op => {
                    vtrCounts[op.vtr] = (vtrCounts[op.vtr] || 0) + 1;
                });
                
                const sortedVtrs = Object.entries(vtrCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5); 
                
                const vtrStatsDiv = document.getElementById('vtrStats');
                if (vtrStatsDiv) {
                    if (sortedVtrs.length > 0) {
                        vtrStatsDiv.innerHTML = sortedVtrs.map(([vtr, count]) => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border dark:border-gray-600">
                                <span class="font-medium">${vtr}</span>
                                <span class="text-lg font-bold text-blue-600 dark:text-blue-400">${count}</span>
                            </div>
                        `).join('');
                    } else {
                        vtrStatsDiv.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Nenhuma VTR utilizada ainda.</p>`;
                    }
                }

                const operationNameCounts = {};
                this.operations.forEach(op => {
                    const nameKey = op.name.trim().toUpperCase() || "Sem Nome";
                    operationNameCounts[nameKey] = (operationNameCounts[nameKey] || 0) + 1;
                });
                
                const sortedTypes = Object.entries(operationNameCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5); 
                
                const typeStatsDiv = document.getElementById('operationTypeStats');
                if (typeStatsDiv) {
                     if (sortedTypes.length > 0) {
                        typeStatsDiv.innerHTML = sortedTypes.map(([type, count]) => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border dark:border-gray-600">
                                <span class="font-medium">${type}</span>
                                <span class="text-lg font-bold text-green-600 dark:text-green-400">${count}</span>
                            </div>
                        `).join('');
                    } else {
                        typeStatsDiv.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Nenhuma operação registrada.</p>`;
                    }
                }
            }
        }

        const fleetSystem = new FleetManagementSystem();
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
